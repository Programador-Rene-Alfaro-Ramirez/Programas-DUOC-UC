--------------------------------------------------------------------------------
-- SEMANA 9 - PRY2205_SEMANA9
-- Base de datos: PRY2205_ACTIVIDAD_S9 (Oracle Cloud)
-- Estudiante: René Alfaro
--------------------------------------------------------------------------------

-- Proyecto "Asesorias Empresariales - MONTENEGRO S.A.”, "

--------------------------------------------------------------------------------
-- SCRIPT 1: ADMIN "estrategias de seguridad creacion de usuarios y roles"
-- EJECUTAR EN: PRY2205_ACTIVIDAD_S9
--------------------------------------------------------------------------------

/* ========================================================================== */
/* LIMPIEZA DE AMBIENTE (RESET)                         */
/* ========================================================================== */
BEGIN EXECUTE IMMEDIATE 'DROP USER PRY2205_EFT CASCADE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP USER PRY2205_EFT_DES CASCADE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP USER PRY2205_EFT_CON CASCADE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP ROLE PRY2205_ROL_D'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP ROLE PRY2205_ROL_C'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

/* ========================================================================== */
/* CASO 1: ESTRATEGIA DE SEGURIDAD (USUARIOS Y ROLES)                         */
/* ========================================================================== */

-- 1. CREACIÓN DE ROLES (Tus nombres personalizados)
CREATE ROLE PRY2205_ROL_D; -- Rol Desarrollador
CREATE ROLE PRY2205_ROL_C; -- Rol Consultor

-- 2. CREACIÓN DE USUARIOS
-- Nota: Agregamos UNLIMITED QUOTA para que no falle al crear tablas o indices
CREATE USER PRY2205_EFT IDENTIFIED BY "Montenegro.2025" 
DEFAULT TABLESPACE DATA QUOTA UNLIMITED ON DATA;

CREATE USER PRY2205_EFT_DES IDENTIFIED BY "Montenegro.2025" 
DEFAULT TABLESPACE DATA QUOTA UNLIMITED ON DATA;

CREATE USER PRY2205_EFT_CON IDENTIFIED BY "Montenegro.2025" 
DEFAULT TABLESPACE DATA QUOTA 10M ON DATA;

-- 3. ASIGNACIÓN DE PRIVILEGIOS DE SISTEMA
-- Permiso básico para conectarse
GRANT CREATE SESSION TO PRY2205_EFT, PRY2205_EFT_DES, PRY2205_EFT_CON;

-- Permisos al DUEÑO (EFT) para construir TODO (Tablas, Vistas, Indices)
GRANT CREATE TABLE, CREATE VIEW, CREATE SEQUENCE, CREATE SYNONYM, CREATE PUBLIC SYNONYM, CREATE ANY INDEX, CREATE PROCEDURE, CREATE TRIGGER TO PRY2205_EFT;

-- Permisos al DESARROLLADOR (EFT_DES) para sus tareas
GRANT CREATE VIEW, CREATE SYNONYM, CREATE TABLE TO PRY2205_EFT_DES;

-- 4. ASIGNACIÓN DE ROLES A LOS USUARIOS
GRANT PRY2205_ROL_D TO PRY2205_EFT_DES;
GRANT PRY2205_ROL_C TO PRY2205_EFT_CON;

PROMPT === CASO 1 COMPLETADO: USUARIOS LISTOS. AHORA EJECUTA EL SCRIPT DEL DUEÑO ===;

--------------------------------------------------------------------------------
-- SCRIPT 2: DUEÑO (Tablas, Datos, Permisos, Vista e Índices)
-- EJECUTAR EN: PRY2205_EFT
--------------------------------------------------------------------------------

-- 1. LIMPIEZA DE OBJETOS
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ASESORIA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE EMPRESA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE PROFESIONAL CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE SECTOR CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE COMUNA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE PROFESION CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE AFP CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ISAPRE CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RANGOS_SUELDOS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE TIPO_CONTRATO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE CARTOLA_PROFESIONALES CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP VIEW VW_EMPRESAS_ASESORADAS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- 2. CREACIÓN DE TABLAS
CREATE TABLE AFP (IDAFP NUMBER(1) PRIMARY KEY, NOMAFP VARCHAR2(20) NOT NULL, PORC NUMBER(5,2) NOT NULL);
CREATE TABLE COMUNA (CODCOMUNA NUMBER PRIMARY KEY, NOMCOMUNA VARCHAR2(20) NOT NULL);
CREATE TABLE ISAPRE (IDISAPRE NUMBER(1) PRIMARY KEY, NOMISAPRE VARCHAR2(20) NOT NULL);
CREATE TABLE SECTOR (CODSECTOR NUMBER PRIMARY KEY, NOMSECTOR VARCHAR2(20) NOT NULL);
CREATE TABLE RANGOS_SUELDOS (IDRANGO NUMBER(2) PRIMARY KEY, S_MIN NUMBER(8), S_MAX NUMBER(8), HONOR_PCT NUMBER(4,2));
CREATE TABLE TIPO_CONTRATO (IDTCONTRATO NUMBER(1) PRIMARY KEY, NOMTCONTRATO VARCHAR2(30), INCENTIVO NUMBER(2));
CREATE TABLE PROFESION (IDPROFESION NUMBER PRIMARY KEY, NOMPROFESION VARCHAR2(25), ASIGNACION NUMBER(8));

CREATE TABLE EMPRESA (
  IDEMPRESA NUMBER PRIMARY KEY, RUT_EMPRESA NUMBER(8) NOT NULL, DV_EMPRESA VARCHAR2(1), CODCOMUNA NUMBER, CODSECTOR NUMBER, 
  NOMEMPRESA VARCHAR2(40), IVA_DECLARADO NUMBER(8), FECHA_INICIACION_ACTIVIDADES DATE,
  CONSTRAINT FK_EMP_SEC FOREIGN KEY (CODSECTOR) REFERENCES SECTOR(CODSECTOR),
  CONSTRAINT FK_EMP_COM FOREIGN KEY (CODCOMUNA) REFERENCES COMUNA(CODCOMUNA)
);

CREATE TABLE PROFESIONAL (
  RUTPROF VARCHAR2(10) PRIMARY KEY, CODCOMUNA NUMBER, IDPROFESION NUMBER, APPPRO VARCHAR2(15), APMPRO VARCHAR2(15), 
  NOMPRO VARCHAR2(20), ECIVPER VARCHAR2(15), SUELDO NUMBER(8), COMISION NUMBER(2,2), IDAFP NUMBER(1), IDISAPRE NUMBER(1), IDTCONTRATO NUMBER(1),
  CONSTRAINT FK_PRO_COM FOREIGN KEY (CODCOMUNA) REFERENCES COMUNA(CODCOMUNA),
  CONSTRAINT FK_PRO_PRO FOREIGN KEY (IDPROFESION) REFERENCES PROFESION(IDPROFESION),
  CONSTRAINT FK_PRO_AFP FOREIGN KEY (IDAFP) REFERENCES AFP(IDAFP),
  CONSTRAINT FK_PRO_ISA FOREIGN KEY (IDISAPRE) REFERENCES ISAPRE(IDISAPRE),
  CONSTRAINT FK_PRO_CON FOREIGN KEY (IDTCONTRATO) REFERENCES TIPO_CONTRATO(IDTCONTRATO)
);

CREATE TABLE ASESORIA (
  RUTPROF VARCHAR2(10) NOT NULL,
  IDEMPRESA NUMBER NOT NULL, 
  HONORARIO NUMBER NOT NULL,
  INICIO DATE NOT NULL, 
  FIN DATE NOT NULL,
  CONSTRAINT PK_ASESORIA PRIMARY KEY (RUTPROF, IDEMPRESA, INICIO), 
  CONSTRAINT FK_ASESORIA_PROFESIONAL FOREIGN KEY (RUTPROF) REFERENCES PROFESIONAL (RUTPROF),
  CONSTRAINT FK_ASESORIA_EMPRESA FOREIGN KEY (IDEMPRESA) REFERENCES EMPRESA (IDEMPRESA)
);

CREATE TABLE CARTOLA_PROFESIONALES (
 RUT_PROFESIONAL VARCHAR2(10), NOMBRE_PROFESIONAL VARCHAR2(50), PROFESION VARCHAR2(25), ISAPRE VARCHAR2(25),
 SUELDO_BASE NUMBER(8), PORC_COMISION_PROFESIONAL NUMBER(2,2), VALOR_TOTAL_COMISION NUMBER(8),
 PORCENTATE_HONORARIO NUMBER(8), BONO_MOVILIZACION NUMBER(6), TOTAL_PAGAR NUMBER(8)
);

-- 3. CARGA DE DATOS
INSERT INTO RANGOS_SUELDOS VALUES (1, 150000, 300000, 40);
INSERT INTO RANGOS_SUELDOS VALUES (2, 300001, 500000, 38);
INSERT INTO RANGOS_SUELDOS VALUES (3, 500001, 800000, 36);
INSERT INTO RANGOS_SUELDOS VALUES (4, 800001, 1200000, 34);
INSERT INTO RANGOS_SUELDOS VALUES (5, 1200001,1500000, 30);
INSERT INTO RANGOS_SUELDOS VALUES (6, 1500001,2000000, 28);
INSERT INTO RANGOS_SUELDOS VALUES (7, 2000001,3000000, 26);
INSERT INTO RANGOS_SUELDOS VALUES (8, 3000001,5000000, 24);

INSERT INTO TIPO_CONTRATO VALUES (1, 'Indefinido Jornada Completa', 15); 
INSERT INTO TIPO_CONTRATO VALUES (2, 'Indefinido Jornada Parcial', 10); 
INSERT INTO AFP VALUES (1, 'CAPITAL', 11.44); INSERT INTO AFP VALUES (2, 'CUPRUM', 11.48); INSERT INTO AFP VALUES (3, 'HABITAT', 11.27);
INSERT INTO AFP VALUES (4, 'MODELO', 10.77); INSERT INTO AFP VALUES (5, 'PLANVITAL', 12.36); INSERT INTO AFP VALUES (6, 'PROVIDA', 11.54); 
INSERT INTO COMUNA VALUES (80,'Las Condes'); INSERT INTO COMUNA VALUES (81,'Providencia'); INSERT INTO COMUNA VALUES (82,'Santiago'); INSERT INTO COMUNA VALUES (83,'Nunoa'); INSERT INTO COMUNA VALUES (84,'Vitacura');

INSERT INTO ISAPRE VALUES (1, 'Ferrosalud'); INSERT INTO ISAPRE VALUES (2, 'Colmena'); INSERT INTO ISAPRE VALUES (3, 'Consalud');
INSERT INTO PROFESION VALUES (10, 'Ingeniero Comercial', 100000); INSERT INTO PROFESION VALUES (20, 'Ingeniero Industrial', 120000);

INSERT INTO SECTOR VALUES (1,'Comunicaciones'); INSERT INTO SECTOR VALUES (2,'Servicios'); INSERT INTO SECTOR VALUES (3,'Banca'); INSERT INTO SECTOR VALUES (4,'Retail');

INSERT INTO EMPRESA VALUES(1,90749000,'9',81,4,'Falabella',33497350, TO_DATE('01/06/1889','dd/mm/yyyy'));
INSERT INTO EMPRESA VALUES(2,83274300,'3',81,4,'Almacenes Paris',9969971, TO_DATE('12/03/1990','dd/mm/yyyy'));

INSERT INTO PROFESIONAL VALUES ('172484794', 80, 10, 'Hurst', 'Gordon', 'Wanda', 'Soltero', 440000, 0.03, 1, 1, 1);
INSERT INTO PROFESIONAL VALUES ('172370233', 81, 10, 'Lang', 'Villanueva', 'Jody', 'Casado', 420000, 0.24, 2, 2, 2);
INSERT INTO PROFESIONAL VALUES ('72842202', 82, 10, 'Mc Intyre', 'Chung', 'Marla', 'Soltero', 300000, 0.58, 3, 1, 1);
INSERT INTO PROFESIONAL VALUES ('198339675', 83, 20, 'Trevino', 'Mc Millan', 'Kendra', 'Divorciado', 1460000, NULL, 4, 2, 1);
INSERT INTO PROFESIONAL VALUES ('196390010', 84, 20, 'Ware', 'Cunningham', 'Clarence', 'Casado', 1340000, 0.71, 5, 3, 2);
COMMIT;

-- GENERADOR DE DATOS PARA ASESORÍA
BEGIN
    FOR i IN 1..80 LOOP
        INSERT INTO ASESORIA (RUTPROF, IDEMPRESA, HONORARIO, INICIO, FIN)
        VALUES ('172484794', 1, 500000, ADD_MONTHS(SYSDATE, -14) + i, ADD_MONTHS(SYSDATE, -13) + i);
    END LOOP;
    FOR i IN 1..60 LOOP
        INSERT INTO ASESORIA (RUTPROF, IDEMPRESA, HONORARIO, INICIO, FIN)
        VALUES ('172370233', 2, 450000, ADD_MONTHS(SYSDATE, -14) + i, ADD_MONTHS(SYSDATE, -13) + i);
    END LOOP;
    COMMIT;
END;
/

-- 4. INFRAESTRUCTURA CASO 2 (SINÓNIMOS Y PERMISOS)
CREATE OR REPLACE PUBLIC SYNONYM SYN_PROFESIONAL FOR PRY2205_EFT.PROFESIONAL;
CREATE OR REPLACE PUBLIC SYNONYM SYN_CARTOLA FOR PRY2205_EFT.CARTOLA_PROFESIONALES;
CREATE OR REPLACE PUBLIC SYNONYM SYN_RANGOS FOR PRY2205_EFT.RANGOS_SUELDOS;
CREATE OR REPLACE PUBLIC SYNONYM SYN_PROFESION FOR PRY2205_EFT.PROFESION;
CREATE OR REPLACE PUBLIC SYNONYM SYN_ISAPRE FOR PRY2205_EFT.ISAPRE;
CREATE OR REPLACE PUBLIC SYNONYM SYN_TCONTRATO FOR PRY2205_EFT.TIPO_CONTRATO;

-- Damos permisos a los Roles
GRANT SELECT ON PROFESIONAL TO PRY2205_ROL_D;
GRANT SELECT ON RANGOS_SUELDOS TO PRY2205_ROL_D;
GRANT SELECT ON PROFESION TO PRY2205_ROL_D;
GRANT SELECT ON ISAPRE TO PRY2205_ROL_D;
GRANT SELECT ON TIPO_CONTRATO TO PRY2205_ROL_D;
GRANT INSERT, UPDATE, DELETE, SELECT ON CARTOLA_PROFESIONALES TO PRY2205_ROL_D;
GRANT SELECT ON CARTOLA_PROFESIONALES TO PRY2205_ROL_C; -- Para el consultor

-- 5. CASO 3.1: VISTA BI
CREATE OR REPLACE VIEW VW_EMPRESAS_ASESORADAS AS
SELECT
    TRIM(TO_CHAR(E.RUT_EMPRESA, '99G999G999', 'NLS_NUMERIC_CHARACTERS='',.''')) || '-' || E.DV_EMPRESA AS RUT_EMPRESA,
    E.NOMEMPRESA AS NOMBRE_EMPRESA,
    E.IVA_DECLARADO AS IVA,
    (EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM E.FECHA_INICIACION_ACTIVIDADES)) AS ANIOS_EXISTENCIA,
    ROUND(COUNT(A.HONORARIO) / 12) AS TOTAL_ASESORIAS_ANUALES,
    TRUNC(E.IVA_DECLARADO * (ROUND(COUNT(A.HONORARIO) / 12) / 100)) AS DEVOLUCION_IVA,
    CASE 
        WHEN ROUND(COUNT(A.HONORARIO) / 12) > 5 THEN 'CLIENTE PREMIUM'
        WHEN ROUND(COUNT(A.HONORARIO) / 12) BETWEEN 3 AND 5 THEN 'CLIENTE'
        ELSE 'CLIENTE POCO CONCURRIDO'
    END AS TIPO_CLIENTE,
    CASE 
        WHEN ROUND(COUNT(A.HONORARIO) / 12) > 5 THEN 
            CASE 
                WHEN ROUND(COUNT(A.HONORARIO) / 12) >= 7 THEN '1 ASESORIA GRATIS'
                ELSE '1 ASESORIA 40% DE DESCUENTO'
            END
        WHEN ROUND(COUNT(A.HONORARIO) / 12) BETWEEN 3 AND 5 THEN 
            CASE 
                WHEN ROUND(COUNT(A.HONORARIO) / 12) = 5 THEN '1 ASESORIA 30% DE DESCUENTO'
                ELSE '1 ASESORIA 20% DE DESCUENTO'
            END
        ELSE 'CAPTAR CLIENTE'
    END AS CORRESPONDE
FROM EMPRESA E
    JOIN ASESORIA A ON E.IDEMPRESA = A.IDEMPRESA
WHERE EXTRACT(YEAR FROM A.FIN) = EXTRACT(YEAR FROM SYSDATE) - 1
GROUP BY 
    E.RUT_EMPRESA, E.DV_EMPRESA, E.NOMEMPRESA, E.IVA_DECLARADO, E.FECHA_INICIACION_ACTIVIDADES; 

GRANT SELECT ON VW_EMPRESAS_ASESORADAS TO PRY2205_ROL_C;

-- 6. CASO 3.2: ÍNDICES
-- Limpieza previa de índices
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_ASESORIA_EMPRESA'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_ASESORIA_FECHA'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP INDEX IDX_ASESORIA_FECHA_FBI'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- 1. Índice B-Tree normal para optimizar el JOIN por IDEMPRESA
CREATE INDEX IDX_ASESORIA_EMPRESA ON ASESORIA(IDEMPRESA);

-- 2. Índice Basado en Función (FBI) para optimizar el filtro EXTRACT(YEAR...)
CREATE INDEX IDX_ASESORIA_FECHA_FBI ON ASESORIA(EXTRACT(YEAR FROM FIN));

-- 3. Actualizar estadísticas para forzar al optimizador a reconocer los nuevos índices
BEGIN
  DBMS_STATS.GATHER_TABLE_STATS(ownname => 'PRY2205_EFT', tabname => 'ASESORIA', cascade => TRUE);
END;
/
-- VALIDACIÓN FINAL: Demostración de uso forzado del índice 
-- Esta consulta utiliza el HINT para mostrar el "INDEX RANGE SCAN" en el plan de ejecución
SELECT /*+ INDEX(A IDX_ASESORIA_FECHA_FBI) */ * FROM EMPRESA E 
JOIN ASESORIA A ON E.IDEMPRESA = A.IDEMPRESA
WHERE EXTRACT(YEAR FROM A.FIN) = EXTRACT(YEAR FROM SYSDATE) - 1;

PROMPT === PASO 2 LISTO: TABLAS, DATOS, INDICES Y PERMISOS CREADOS ===;

--------------------------------------------------------------------------------
-- SCRIPT 3: DESARROLLADOR (Lógica de Negocio - Informe de Sueldos)
-- EJECUTAR EN: PRY2205_EFT_DES
--------------------------------------------------------------------------------
SET SERVEROUTPUT ON;

DECLARE
    -- Cursor para traer los datos usando los SINÓNIMOS (SYN_)
    CURSOR cur_profesionales IS
        SELECT P.RUTPROF, P.NOMPRO || ' ' || P.APPPRO || ' ' || P.APMPRO AS NOMBRE_COMPLETO,
               PR.NOMPROFESION, I.NOMISAPRE, P.SUELDO, P.COMISION, TC.INCENTIVO
        FROM SYN_PROFESIONAL P
        JOIN SYN_PROFESION PR ON P.IDPROFESION = PR.IDPROFESION
        JOIN SYN_ISAPRE I ON P.IDISAPRE = I.IDISAPRE
        JOIN SYN_TCONTRATO TC ON P.IDTCONTRATO = TC.IDTCONTRATO;

    v_bono_movilizacion NUMBER(8);
    v_total_comision NUMBER(8);
    v_porc_honorario NUMBER(4,2);
    v_monto_honorario NUMBER(8);
    v_total_pagar NUMBER(8);

BEGIN
    -- 1. Limpiamos la tabla antes de rellenarla
    DELETE FROM SYN_CARTOLA;
    COMMIT; 

    -- 2. Recorremos cada profesional
    FOR r_prof IN cur_profesionales LOOP
        
        -- A. Cálculo Bono Movilización
        IF r_prof.INCENTIVO > 0 THEN 
            v_bono_movilizacion := (r_prof.SUELDO * r_prof.INCENTIVO) / 100; 
        ELSE 
            v_bono_movilizacion := 0; 
        END IF;

        -- B. Cálculo Comisiones
        IF r_prof.COMISION > 0 THEN 
            v_total_comision := r_prof.SUELDO * r_prof.COMISION; 
        ELSE 
            v_total_comision := 0; 
        END IF;

        -- C. Buscar el porcentaje en la tabla de rangos
        SELECT HONOR_PCT INTO v_porc_honorario 
        FROM SYN_RANGOS 
        WHERE r_prof.SUELDO BETWEEN S_MIN AND S_MAX;
        
        -- D. CALCULO CRÍTICO: Transformar % a DINERO
        v_monto_honorario := r_prof.SUELDO * (v_porc_honorario / 100);

        -- E. Suma total
        v_total_pagar := r_prof.SUELDO + v_total_comision + v_monto_honorario + v_bono_movilizacion;

        -- F. Insertar en la Cartola
        INSERT INTO SYN_CARTOLA (
            RUT_PROFESIONAL, NOMBRE_PROFESIONAL, PROFESION, ISAPRE,
            SUELDO_BASE, PORC_COMISION_PROFESIONAL, VALOR_TOTAL_COMISION,
            PORCENTATE_HONORARIO, BONO_MOVILIZACION, TOTAL_PAGAR
        ) VALUES (
            r_prof.RUTPROF, r_prof.NOMBRE_COMPLETO, r_prof.NOMPROFESION, r_prof.NOMISAPRE,
            r_prof.SUELDO, NVL(r_prof.COMISION, 0), v_total_comision,
            v_monto_honorario, -- Aquí va el dinero calculado
            v_bono_movilizacion, v_total_pagar
        );
    END LOOP;

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Proceso completado exitosamente.');
END;
/

-- MOSTRAR EL RESULTADO FINAL
SELECT * FROM SYN_CARTOLA;

--------------------------------------------------------------------------------
-- SCRIPT 4: USUARIO CONSULTOR (PRY2205_EFT_CON)
-- EJECUTAR EN: PRY2205_EFT_CON
--------------------------------------------------------------------------------

-- -----------------------------------------------------------------------------
-- Visualizar los informes finales (Caso 2 y Caso 3)
-- -----------------------------------------------------------------------------
-- 1. VER EL INFORME DE SUELDOS (CASO 2 - Hecho por el Desarrollador)
-- Usamos el sinónimo público SYN_CARTOLA
SELECT * FROM SYN_CARTOLA;

-- 2. VER EL INFORME DE BI/EMPRESAS (CASO 3 - Hecho por el Dueño)
-- La vista pública creada por el dueño
SELECT * FROM PRY2205_EFT.VW_EMPRESAS_ASESORADAS ORDER BY NOMBRE_EMPRESA ASC;

-- fin del script
