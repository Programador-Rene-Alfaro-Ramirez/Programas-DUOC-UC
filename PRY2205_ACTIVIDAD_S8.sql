-- ----------------------------------------------------------------------------- 
-- SEMANA 8 - PRY2205_SEMANA8
-- Base de datos: PRY2205_ACTIVIDAD_S8 (Oracle Cloud) 
-- Estudiante: René Alfaro 
-- -----------------------------------------------------------------------------

-- Proyecto "Procesos de gestión de biblioteca - DBMS COLLEGE"

-- =============================================================================
-- BLOQUE ADMIN: Configuración y Creación de Usuarios/Roles
-- =============================================================================

-- 1. Limpieza de Usuarios y Roles (Si existen) 
BEGIN
   EXECUTE IMMEDIATE 'DROP USER PRY2205_USER1 CASCADE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/
BEGIN
   EXECUTE IMMEDIATE 'DROP USER PRY2205_USER2 CASCADE';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/
BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE PRY2205_ROL_D';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/
BEGIN
   EXECUTE IMMEDIATE 'DROP ROLE PRY2205_ROL_P';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/

-- 2. Creación de ROLES
CREATE ROLE PRY2205_ROL_D;
CREATE ROLE PRY2205_ROL_P;

-- 3. Asignación de Permisos a los ROLES
-- ROL DUEÑO (USER1): Permisos para crear todo
GRANT CONNECT, RESOURCE TO PRY2205_ROL_D;
GRANT CREATE VIEW, CREATE INDEX TO PRY2205_ROL_D;
GRANT CREATE PUBLIC SYNONYM, CREATE SYNONYM TO PRY2205_ROL_D;
GRANT CREATE TABLE TO PRY2205_ROL_D;


-- ROL PROGRAMADOR (USER2): Permisos para el Caso 2
GRANT CONNECT, RESOURCE TO PRY2205_ROL_P;
GRANT CREATE SEQUENCE TO PRY2205_ROL_P;
GRANT CREATE TABLE TO PRY2205_ROL_P;


-- 4. Creación de USUARIOS para CLOUD
CREATE USER PRY2205_USER1 
IDENTIFIED BY "Duoc.2024_Semana8" 
DEFAULT TABLESPACE DATA
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON DATA;

CREATE USER PRY2205_USER2 
IDENTIFIED BY "Duoc.2024_Semana8" 
DEFAULT TABLESPACE DATA
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON DATA;

-- 5. Asignar Roles a los Usuarios
GRANT PRY2205_ROL_D TO PRY2205_USER1;
GRANT PRY2205_ROL_P TO PRY2205_USER2;

-- Guardar cambios
COMMIT;

-- =============================================================================
-- CASO 1: "Estrategia de seguridad"
-- =============================================================================
-- -----------------------------------------------------------------------------
-- DENTRO DE LA CONEXION USER 1
-- EJECUTADO POR PRY2205_USER1 (DUEÑO)
-- CASO 1: CREAR TABLAS, POBLAMIENTO Y SINÓNIMOS
-- -----------------------------------------------------------------------------

-- inserción de datos https://ava.duoc.cl/bbcswebdav/xid-9336031_1
ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/RRRR'; 

-- ------------------ ELIMINACIÓN DE TABLAS ------------------
DROP TABLE AUTOR CASCADE CONSTRAINTS;
DROP TABLE CARRERA CASCADE CONSTRAINTS;
DROP TABLE EDITORIAL CASCADE CONSTRAINTS;
DROP TABLE EJEMPLAR CASCADE CONSTRAINTS;
DROP TABLE EMPLEADO CASCADE CONSTRAINTS;
DROP TABLE ESCUELA CASCADE CONSTRAINTS;
DROP TABLE ALUMNO CASCADE CONSTRAINTS;
DROP TABLE PRESTAMO CASCADE CONSTRAINTS;
DROP TABLE LIBRO CASCADE CONSTRAINTS;
DROP TABLE VALOR_MULTA_PRESTAMO;
DROP TABLE DETALLE_PRESTAMO_MENSUAL;
DROP TABLE REBAJA_MULTA CASCADE CONSTRAINTS; 
DROP TABLE RESUMEN_PRESTAMO_MENSUAL;
DROP TABLE ERROR_PROCESO_PRESTAMO CASCADE CONSTRAINTS;


-- ------------------ CREACION DE TABLAS ------------------
CREATE TABLE AUTOR(
  libroid       NUMBER (5) NOT NULL,
  autorid       NUMBER (3) NOT NULL,
  nombre        VARCHAR2 (40) NOT NULL,
  apellidos     VARCHAR2 (40));
ALTER TABLE AUTOR ADD CONSTRAINT AUTOR_PK PRIMARY KEY (libroid,autorid);

CREATE TABLE CARRERA(
  carreraid   NUMBER (3) NOT NULL,
  descripcion VARCHAR2 (50) NOT NULL,
  escuelaid   NUMBER (3) NOT NULL);
ALTER TABLE CARRERA ADD CONSTRAINT CARRERA_PK PRIMARY KEY (carreraid);

CREATE TABLE EDITORIAL(
  editorialid NUMBER (3) NOT NULL,
  descripcion VARCHAR2 (30) NOT NULL);
ALTER TABLE EDITORIAL ADD CONSTRAINT EDITORIAL_PK PRIMARY KEY (editorialid);

CREATE TABLE EJEMPLAR(
  libroid   NUMBER (5) NOT NULL,
  ejemplarid VARCHAR2 (4) NOT NULL,
  ISBN      VARCHAR2 (20) NOT NULL);
ALTER TABLE EJEMPLAR ADD CONSTRAINT EJEMPLAR_PK PRIMARY KEY (ejemplarid,libroid);

CREATE TABLE EMPLEADO(
  empleadoid      NUMBER (3) NOT NULL,
  nombre          VARCHAR2 (20) NOT NULL,
  apaterno        VARCHAR2 (20) NOT NULL,
  amaterno        VARCHAR2 (20) NOT NULL,
  fecha_contrato DATE NOT NULL,
  salario         NUMBER (8) NOT NULL,
  jefeid          NUMBER (3));
ALTER TABLE EMPLEADO ADD CONSTRAINT EMPLEADO_PK PRIMARY KEY (empleadoid);

CREATE TABLE ESCUELA(
  escuelaid   NUMBER (3) NOT NULL,
  descripcion VARCHAR2 (30) NOT NULL);
ALTER TABLE ESCUELA ADD CONSTRAINT ESCUELA_PK PRIMARY KEY (escuelaid);

CREATE TABLE ALUMNO(
  alumnoid      NUMBER (3) NOT NULL,
  nombre          VARCHAR2 (20) NOT NULL,
  apaterno        VARCHAR2 (20) NOT NULL,
  amaterno        VARCHAR2 (20) NOT NULL,
  genero          VARCHAR2 (1),
  fecha_nacimiento DATE,
  carreraid       NUMBER (3) NOT NULL);
ALTER TABLE ALUMNO ADD CONSTRAINT ALUMNO_PK PRIMARY KEY (alumnoid);

CREATE TABLE PRESTAMO(
  prestamoid    NUMBER (5) NOT NULL,
  fecha_inicio  DATE NOT NULL,
  hora_inicio   VARCHAR2 (5) NOT NULL,
  fecha_termino DATE NOT NULL,
  hora_termino  VARCHAR2 (5) NOT NULL,
  fecha_entrega DATE,
  hora_entrega  VARCHAR2 (5),
  libroid       NUMBER (5) NOT NULL,
  ejemplarid    VARCHAR2 (4) NOT NULL,
  alumnoid      NUMBER (3) NOT NULL,
  empleadoid    NUMBER (3) NOT NULL);
ALTER TABLE PRESTAMO ADD CONSTRAINT PRESTAMO_PK PRIMARY KEY (prestamoid);

CREATE TABLE LIBRO(
  libroid     NUMBER (5) NOT NULL,
  nombre_libro        VARCHAR2 (70) NOT NULL,
  publicacion NUMBER (4) NOT NULL,
  paginas     NUMBER (4) NOT NULL,
  precio      NUMBER (6),
  editorialid NUMBER (3));
ALTER TABLE LIBRO ADD CONSTRAINT LIBRO_PK PRIMARY KEY (libroid);

CREATE TABLE VALOR_MULTA_PRESTAMO 
(cant_dias_ini   NUMBER(2) NOT NULL,
  cant_dias_ter   NUMBER(2) NOT NULL,
  valor_multa     NUMBER(7) NOT NULL); 
 ALTER TABLE VALOR_MULTA_PRESTAMO ADD CONSTRAINT PK_VALOR_MULTA_PRESTAMO PRIMARY KEY (cant_dias_ini);

CREATE TABLE REBAJA_MULTA
(carreraid   NUMBER (3) NOT NULL,
  porc_rebaja_multa NUMBER(2) NOT NULL);
ALTER TABLE REBAJA_MULTA ADD CONSTRAINT PK_REBAJA_MULTA PRIMARY KEY (carreraid);

CREATE TABLE DETALLE_PRESTAMO_MENSUAL 
(correlativo NUMBER(6) NOT NULL,
  fecha_proceso VARCHAR2(7) NOT NULL,
  prestamoid NUMBER (5) NOT NULL,
  libro VARCHAR2(100) NOT NULL,
  ejemplarid VARCHAR2 (4) NOT NULL,
  alumno VARCHAR2(100) NOT NULL,
  carrera VARCHAR2(100) NOT NULL,
  dias_atraso_devolucion NUMBER(5) NOT NULL,
  valor_multa NUMBER(10));
 ALTER TABLE DETALLE_PRESTAMO_MENSUAL  ADD CONSTRAINT PK_DET_PRESTAMO_MENSUAL PRIMARY KEY (correlativo,fecha_proceso);

CREATE TABLE RESUMEN_PRESTAMO_MENSUAL
(correlativo NUMBER(5) NOT NULL,
  fecha_proceso VARCHAR2(7) NOT NULL,
  carrera VARCHAR2(50) NOT NULL,
  total_alumnos_carrera NUMBER NOT NULL,
  total_alumnos_solic_libro NUMBER(5) NOT NULL,
  total_devol_en_plazo NUMBER(3) NOT NULL,
  total_devol_fuera_plazo NUMBER(3) NOT NULL,
  valor_total_multa NUMBER(10) NOT NULL);
ALTER TABLE RESUMEN_PRESTAMO_MENSUAL  ADD CONSTRAINT PK_RESUMEN_PRESTAMO_MENSUAL PRIMARY KEY (correlativo,fecha_proceso);

CREATE TABLE ERROR_PROCESO_PRESTAMO
(correlativo NUMBER(5) NOT NULL,
  sentencia_error VARCHAR2(70) NOT NULL,
  mensaje_error VARCHAR2(200) NOT NULL);
ALTER TABLE ERROR_PROCESO_PRESTAMO  ADD CONSTRAINT PK_ERROR_PROCESO_PRESTAMO PRIMARY KEY (correlativo);

-- ------------------ RELACIONES (FOREIGN KEYS) ------------------
ALTER TABLE AUTOR ADD CONSTRAINT AUTOR_LIBRO_FK FOREIGN KEY (libroid) REFERENCES LIBRO (libroid);
ALTER TABLE CARRERA ADD CONSTRAINT CARRERA_ESCUELA_FK FOREIGN KEY (escuelaid) REFERENCES ESCUELA (escuelaid);
ALTER TABLE EJEMPLAR ADD CONSTRAINT EJEMPLAR_LIBRO_FK FOREIGN KEY (libroid) REFERENCES LIBRO (libroid);
ALTER TABLE EMPLEADO ADD CONSTRAINT EMPLEADO_EMPLEADO_FK FOREIGN KEY (jefeid) REFERENCES EMPLEADO (empleadoid);
ALTER TABLE ALUMNO ADD CONSTRAINT ALUMNO_CARRERA_FK FOREIGN KEY (carreraid) REFERENCES CARRERA (carreraid);
ALTER TABLE PRESTAMO ADD CONSTRAINT PRESTAMO_EJEMPLAR_FK FOREIGN KEY (ejemplarid,libroid) REFERENCES EJEMPLAR (ejemplarid,libroid);
ALTER TABLE PRESTAMO ADD CONSTRAINT PRESTAMO_EMPLEADO_FK FOREIGN KEY (empleadoid) REFERENCES EMPLEADO (empleadoid);
ALTER TABLE PRESTAMO ADD CONSTRAINT PRESTAMO_ALUMNO_FK FOREIGN KEY (alumnoid) REFERENCES ALUMNO (alumnoid);
ALTER TABLE LIBRO ADD CONSTRAINT LIBRO_EDITORIAL_FK FOREIGN KEY (editorialid) REFERENCES EDITORIAL (editorialid);
ALTER TABLE REBAJA_MULTA ADD CONSTRAINT LFK_REBAJA_MULTA FOREIGN KEY (carreraid) REFERENCES CARRERA(carreraid);


-- ------------------ POBLADO DE TABLAS ------------------
INSERT INTO VALOR_MULTA_PRESTAMO VALUES(1,3,2000);
INSERT INTO VALOR_MULTA_PRESTAMO VALUES(3,5,5000);
INSERT INTO VALOR_MULTA_PRESTAMO VALUES(7,9,8000);
INSERT INTO VALOR_MULTA_PRESTAMO VALUES(10,12,10000);
INSERT INTO VALOR_MULTA_PRESTAMO VALUES(13,99,20000);

INSERT INTO editorial VALUES(100,'Alfaomega');
INSERT INTO editorial VALUES(110,'Alianza');
INSERT INTO editorial VALUES(120,'Anaya');
INSERT INTO editorial VALUES(130,'Blume');
INSERT INTO editorial VALUES(140,'Bosch');
INSERT INTO editorial VALUES(150,'Ceac');
INSERT INTO editorial VALUES(160,'Cisco');
INSERT INTO editorial VALUES(170,'Deusto');
INSERT INTO editorial VALUES(180,'Fantastico');
INSERT INTO editorial VALUES(190,'Gedisa');
INSERT INTO editorial VALUES(200,'Gestion');
INSERT INTO editorial VALUES(210,'Graphis');
INSERT INTO editorial VALUES(220,'Gustavo gili');
INSERT INTO editorial VALUES(230,'Iortv');
INSERT INTO editorial VALUES(240,'Juridica de chile');
INSERT INTO editorial VALUES(250,'LexisNexis');
INSERT INTO editorial VALUES(260,'Lexus');
INSERT INTO editorial VALUES(270,'Limusa');
INSERT INTO editorial VALUES(280,'McGraw-Hill');
INSERT INTO editorial VALUES(290,'Medica panamericana');
INSERT INTO editorial VALUES(300,'Mediterraneo');
INSERT INTO editorial VALUES(310,'Oceano');
INSERT INTO editorial VALUES(320,'Paidos');
INSERT INTO editorial VALUES(330,'Paramon');
INSERT INTO editorial VALUES(340,'Paraninfo');
INSERT INTO editorial VALUES(350,'Pearson');
INSERT INTO editorial VALUES(360,'Piramide');
INSERT INTO editorial VALUES(370,'Planeta');
INSERT INTO editorial VALUES(380,'Prentice-Hall');
INSERT INTO editorial VALUES(390,'Reverte');


INSERT INTO escuela VALUES('10','Turismo');
INSERT INTO escuela VALUES('20','Salud');
INSERT INTO escuela VALUES('30','Ingenieria');
INSERT INTO escuela VALUES('40','Administracion');
INSERT INTO escuela VALUES('50','Informatica');
INSERT INTO escuela VALUES('60','Comunicacion');
INSERT INTO escuela VALUES('70','Diseno');

INSERT INTO CARRERA VALUES(101, 'Ingenieria en Prevencion de Riesgos', 30);
INSERT INTO CARRERA VALUES(102, 'Gastronomia', 10); 
INSERT INTO CARRERA VALUES(103, 'Publicidad', 60); 
INSERT INTO CARRERA VALUES(104, 'Diseno Industrial', 70); 
INSERT INTO CARRERA VALUES(200, 'Ingenieria Informatica', 50); 
INSERT INTO CARRERA VALUES(201, 'Contabilidad', 40);

INSERT INTO REBAJA_MULTA VALUES(101, 6);
INSERT INTO REBAJA_MULTA VALUES(102, 10);
INSERT INTO REBAJA_MULTA VALUES(103, 5);
INSERT INTO REBAJA_MULTA VALUES(104, 3);

INSERT INTO EMPLEADO VALUES(150, 'Juan', 'Perez', 'Diaz', '01/01/2019', 800000, NULL);
INSERT INTO EMPLEADO VALUES(180, 'Maria', 'Lopez', 'Soto', '15/05/2020', 950000, 150);
INSERT INTO EMPLEADO VALUES(190, 'Pedro', 'Gomez', 'Rojas', '20/08/2021', 1100000, 150);
INSERT INTO EMPLEADO VALUES(200, 'Ana', 'Silva', 'Cid', '10/03/2022', 750000, 180);

INSERT INTO ALUMNO VALUES(501, 'Sofia', 'Muñoz', 'Vargas', 'F', '10/01/2000', 101);
INSERT INTO ALUMNO VALUES(502, 'Bastian', 'Cortes', 'Flores', 'M', '15/02/2001', 200);

INSERT INTO LIBRO VALUES(10926, 'CCNP switch 642-813: official certification guide', 2011, 800, 50000, 160);
INSERT INTO LIBRO VALUES(13733, 'Principios basicos de auditoria', 2015, 650, 30000, 200);

INSERT INTO EJEMPLAR VALUES(10926, 'E001', 'ISBN-901');
INSERT INTO EJEMPLAR VALUES(10926, 'E002', 'ISBN-902');
INSERT INTO EJEMPLAR VALUES(13733, 'E003', 'ISBN-903');
INSERT INTO EJEMPLAR VALUES(13733, 'E004', 'ISBN-904');

INSERT INTO PRESTAMO VALUES (10010, TO_DATE('10/03/2023','DD/MM/RRRR'), '09:00', TO_DATE('24/03/2023','DD/MM/RRRR'), '18:00', TO_DATE('24/03/2023','DD/MM/RRRR'), '17:00', 10926, 'E001', 501, 150); 
INSERT INTO PRESTAMO VALUES (10020, TO_DATE('01/05/2023','DD/MM/RRRR'), '09:00', TO_DATE('15/05/2023','DD/MM/RRRR'), '18:00', TO_DATE('20/05/2023','DD/MM/RRRR'), '10:00', 13733, 'E003', 501, 180); 
INSERT INTO PRESTAMO VALUES (10030, TO_DATE('01/06/2023','DD/MM/RRRR'), '10:00', TO_DATE('15/06/2023','DD/MM/RRRR'), '18:00', TO_DATE('25/06/2023','DD/MM/RRRR'), '11:00', 13733, 'E004', 502, 190); 

COMMIT;

-- 2. CREAR SINÓNIMOS PÚBLICOS
-- Se crean para ocultar el nombre del dueño (PRY2205_USER1) a los programadores
CREATE OR REPLACE PUBLIC SYNONYM SYN_ESCUELA FOR PRY2205_USER1.ESCUELA;
CREATE OR REPLACE PUBLIC SYNONYM SYN_CARRERA FOR PRY2205_USER1.CARRERA;
CREATE OR REPLACE PUBLIC SYNONYM SYN_ALUMNO FOR PRY2205_USER1.ALUMNO;
CREATE OR REPLACE PUBLIC SYNONYM SYN_PRESTAMO FOR PRY2205_USER1.PRESTAMO;
CREATE OR REPLACE PUBLIC SYNONYM SYN_EMPLEADO FOR PRY2205_USER1.EMPLEADO;
CREATE OR REPLACE PUBLIC SYNONYM SYN_EJEMPLAR FOR PRY2205_USER1.EJEMPLAR;
CREATE OR REPLACE PUBLIC SYNONYM SYN_LIBRO FOR PRY2205_USER1.LIBRO;
CREATE OR REPLACE PUBLIC SYNONYM SYN_EDITORIAL FOR PRY2205_USER1.EDITORIAL;
CREATE OR REPLACE PUBLIC SYNONYM SYN_AUTOR FOR PRY2205_USER1.AUTOR;
CREATE OR REPLACE PUBLIC SYNONYM SYN_REBAJA FOR PRY2205_USER1.REBAJA_MULTA;

-- 3. DAR PERMISOS AL ROL DEL OTRO USUARIO (PROGRAMADOR)
GRANT SELECT ON ESCUELA TO PRY2205_ROL_P;
GRANT SELECT ON CARRERA TO PRY2205_ROL_P;
GRANT SELECT ON ALUMNO TO PRY2205_ROL_P;
GRANT SELECT ON PRESTAMO TO PRY2205_ROL_P;
GRANT SELECT ON EMPLEADO TO PRY2205_ROL_P;
GRANT SELECT ON EJEMPLAR TO PRY2205_ROL_P;
GRANT SELECT ON LIBRO TO PRY2205_ROL_P;
GRANT SELECT ON EDITORIAL TO PRY2205_ROL_P;
GRANT SELECT ON AUTOR TO PRY2205_ROL_P;
GRANT SELECT ON REBAJA_MULTA TO PRY2205_ROL_P;

COMMIT;

-- =============================================================================
-- CASO 2: "Creación de Informe de Stock"
-- =============================================================================
-- -----------------------------------------------------------------------------
-- DENTRO DE LA CONEXION USER 2
-- EJECUTADO POR PRY2205_USER2 (PROGRAMADOR)
-- CASO 2: CREACIÓN DE INFORME DE STOCK
-- -----------------------------------------------------------------------------

-- 1. CREAR SECUENCIA (Para numerar el informe)
CREATE SEQUENCE SEQ_CONTROL_STOCK START WITH 1 INCREMENT BY 1;

-- 2. CREAR TABLA DE INFORME
CREATE TABLE CONTROL_STOCK_LIBROS (
    ID_CONTROL NUMBER(10) PRIMARY KEY,
    LIBRO_ID NUMBER(5),
    NOMBRE_LIBRO VARCHAR2(100), 
    TOTAL_EJEMPLARES NUMBER(5),
    EN_PRESTAMO NUMBER(5),
    DISPONIBLES NUMBER(5),
    PORCENTAJE_PRESTAMO NUMBER(5,2), 
    STOCK_CRITICO VARCHAR2(10) 
);

-- 3. INSERTAR DATOS (Lógica Automática)
INSERT INTO CONTROL_STOCK_LIBROS
SELECT 
    SEQ_CONTROL_STOCK.NEXTVAL AS ID_CONTROL,
    L.LIBROID AS LIBRO_ID,
    L.NOMBRE_LIBRO,
    
    -- Subconsulta para contar TOTAL de ejemplares
    (SELECT COUNT(*) FROM SYN_EJEMPLAR E_TOT WHERE E_TOT.LIBRO_LIBROID = L.LIBROID) AS TOTAL_EJEMPLARES,
    
    COUNT(P.PRESTAMOID) AS EN_PRESTAMO,
    
    -- Disponibles = Total - Prestados
    (SELECT COUNT(*) FROM SYN_EJEMPLAR E_TOT WHERE E_TOT.LIBRO_LIBROID = L.LIBROID) - COUNT(P.PRESTAMOID) AS DISPONIBLES,
    
    -- Porcentaje
    ROUND((COUNT(P.PRESTAMOID) * 100) / 
          (SELECT COUNT(*) FROM SYN_EJEMPLAR E_TOT WHERE E_TOT.LIBRO_LIBROID = L.LIBROID), 2) AS PORCENTAJE_PRESTAMO,
            
    -- Stock Crítico
    CASE 
        WHEN ((SELECT COUNT(*) FROM SYN_EJEMPLAR E_TOT WHERE E_TOT.LIBRO_LIBROID = L.LIBROID) - COUNT(P.PRESTAMOID)) > 2 
        THEN 'S' 
        ELSE 'N' 
    END AS STOCK_CRITICO

FROM SYN_PRESTAMO P
JOIN SYN_EMPLEADO E ON P.EMPLEADOID = E.EMPLEADOID -- Ajustado a EMPLEADOID
JOIN SYN_EJEMPLAR EJ ON P.EJEMPLARID = EJ.EJEMPLARID AND P.LIBROID = EJ.LIBROID
JOIN SYN_LIBRO L ON EJ.LIBROID = L.LIBROID

WHERE 
    -- Filtro de Fecha: Dinámico (hace 2 años)
    EXTRACT(YEAR FROM P.FECHA_INICIO) = EXTRACT(YEAR FROM SYSDATE) - 2
    -- Filtro de Empleados
    AND P.EMPLEADOID IN (190, 180, 150)

GROUP BY L.LIBROID, L.NOMBRE_LIBRO
ORDER BY L.LIBROID;

-- Confirmar
COMMIT;

-- VERIFICACIÓN
SELECT * FROM CONTROL_STOCK_LIBROS;

-- =============================================================================
-- CASO 3: "Optimización de sentencias SQL"
-- =============================================================================

-- -----------------------------------------------------------------------------
-- DENTRO DE LA CONEXION USER 1
-- EJECUTADO POR PRY2205_USER1 (DUEÑO)
-- CASO 3: OPTIMIZACIÓN (VISTAS E ÍNDICES)
-- -----------------------------------------------------------------------------

-- 3.1 CREACIÓN DE VISTA VW_DETALLE_MULTAS
CREATE OR REPLACE VIEW VW_DETALLE_MULTAS AS
SELECT 
    P.PRESTAMOID AS ID_PRESTAMO,
    INITCAP(A.NOMBRE || ' ' || A.APATERNO) AS NOMBRE_ALUMNO,
    C.DESCRIPCION AS NOMBRE_CARRERA,
    L.LIBROID AS ID_LIBRO,
    TO_CHAR(L.PRECIO, '$999,999') AS VALOR_LIBRO,
    P.FECHA_TERMINO,
    P.FECHA_ENTREGA,
    (P.FECHA_ENTREGA - P.FECHA_TERMINO) AS DIAS_ATRASO,
    
    -- Cálculo Valor Multa: 3% del precio * días de atraso
    TO_CHAR((L.PRECIO * 0.03 * (P.FECHA_ENTREGA - P.FECHA_TERMINO)), '$999,999') AS VALOR_MULTA,
    
    -- Porcentaje de Rebaja: NVL por si no tiene convenio
    NVL(R.PORC_REBAJA_MULTA, 0) AS PORCENTAJE_REBAJA_MULTA,
    
    -- Valor Final Rebajado: Multa - (Multa * Porcentaje/100)
    TO_CHAR(
        (L.PRECIO * 0.03 * (P.FECHA_ENTREGA - P.FECHA_TERMINO)) - 
        ((L.PRECIO * 0.03 * (P.FECHA_ENTREGA - P.FECHA_TERMINO)) * NVL(R.PORC_REBAJA_MULTA, 0) / 100),
        '$999,999'
    ) AS VALOR_REBAJADO

FROM SYN_PRESTAMO P
JOIN SYN_ALUMNO A ON P.ALUMNOID = A.ALUMNOID
JOIN SYN_CARRERA C ON A.CARRERAID = C.CARRERAID
JOIN SYN_EJEMPLAR E ON P.EJEMPLARID = E.EJEMPLARID AND P.LIBROID = E.LIBROID
JOIN SYN_LIBRO L ON E.LIBROID = L.LIBROID
LEFT JOIN SYN_REBAJA R ON C.CARRERAID = R.CARRERAID

WHERE 
    -- Filtro 1: Fecha de término de hace 2 años
    EXTRACT(YEAR FROM P.FECHA_TERMINO) = EXTRACT(YEAR FROM SYSDATE) - 2
    -- Filtro 2: Entregados con atraso
    AND P.FECHA_ENTREGA > P.FECHA_TERMINO
ORDER BY P.FECHA_ENTREGA DESC;


-- 3.2 CREACIÓN DE ÍNDICE
-- Bloque de seguridad para evitar error si el índice ya existe
BEGIN
  EXECUTE IMMEDIATE 'DROP INDEX IDX_FECHA_ENTREGA';
EXCEPTION
  WHEN OTHERS THEN NULL;
END;
/

-- Índice para optimizar el ORDER BY y el filtro en la columna FECHA_ENTREGA
CREATE INDEX IDX_FECHA_ENTREGA ON PRESTAMO(FECHA_ENTREGA);

COMMIT;

-- VERIFICACIÓN FINAL
SELECT * FROM VW_DETALLE_MULTAS;

-- FIN DEL SCRIPT